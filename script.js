let soundEnabled = true;
let audioContext = null;
const achievements = new Set(JSON.parse(localStorage.getItem('chenle_achievements') || '[]'));
let miningBlocksDestroyed = 0;
let photosViewed = new Set();
let hasShownWelcomeTip = localStorage.getItem('chenle_welcome_tip_shown') === 'true';

// ToastÊèêÁ§∫ÂáΩÊï∞
function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;

    container.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ÊåâÈíÆÁÇπÂáªÂèçÈ¶àÂáΩÊï∞
function buttonClickFeedback(button) {
    button.classList.add('btn-flash');
    setTimeout(() => {
        button.classList.remove('btn-flash');
    }, 300);
}

document.addEventListener('DOMContentLoaded', function() {
    try {
        initLoadingScreen();
        initAudioContext();
        init3DFloatingBlocks();
        initFireworks();
        initPortalEffect();
        initSoundToggle();
        initBlessingGenerator();
        initMiningGame();
        initCakeBuilding();
        initVillagerNPC();
        initBlockInteraction();
        initPhotoPixelate();
        initPhotoGestures();
        initHiddenCreeper();
        initPixelCake();
        initPhotoModal();
        
        console.log('%cüéâ ÁîüÊó•Âø´‰πêÔºåÂàòÂÆ∏‰πêÔºÅüéâ', 'font-size: 30px; color: #FFD700; text-shadow: 2px 2px 4px #000;');
        console.log('%c‚úÖ ÊâÄÊúâÂäüËÉΩÂ∑≤ÊàêÂäüÂàùÂßãÂåñ', 'font-size: 16px; color: #4CAF50;');
    } catch (error) {
        console.error('‚ùå ÂàùÂßãÂåñÈîôËØØ:', error);
    }
});

function initLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    const welcomeTip = document.getElementById('welcomeTip');
    
    window.addEventListener('load', () => {
        setTimeout(() => {
            loadingScreen.classList.add('hidden');
            
            setTimeout(() => {
                launchFireworks();
                unlockAchievement('welcome', 'üéâ Ê¨¢ËøéÔºÅ', 'ÂèÇÂä†ÂàòÂÆ∏‰πêÁöÑ5Â≤ÅÁîüÊó•‰ºöÔºÅ');
                playSound('portal');
                
                if (!hasShownWelcomeTip) {
                    setTimeout(() => {
                        welcomeTip.classList.add('show');
                        setTimeout(() => {
                            welcomeTip.classList.remove('show');
                            localStorage.setItem('chenle_welcome_tip_shown', 'true');
                        }, 3000);
                    }, 500);
                }
            }, 500);
            
            document.getElementById('mainBanner').addEventListener('click', () => {
                launchFireworks();
                playSound('experience');
            });
        }, 1500);
    });
}

function initAudioContext() {
    // ÁßªÂä®Á´ØÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÊâçËÉΩÂàùÂßãÂåñÈü≥È¢ë
    const initAudio = () => {
        if (!audioContext && (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined')) {
            const AudioContextClass = AudioContext || webkitAudioContext;
            audioContext = new AudioContextClass();

            // ÁßªÂä®Á´ØÈúÄË¶Å resume
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            console.log('‚úÖ Èü≥È¢ëÁ≥ªÁªüÂ∑≤ÂàùÂßãÂåñ');
            showToast('üîä Èü≥ÊïàÂ∑≤ÂêØÁî®ÔºÅ', 'info');
        }
    };

    // Á´ãÂç≥Â∞ùËØïÂàùÂßãÂåñ
    initAudio();

    // ÂêåÊó∂ÁõëÂê¨È¶ñÊ¨°Áî®Êà∑‰∫§‰∫íÔºàÁßªÂä®Á´ØÈúÄË¶ÅÔºâ
    const userInteractionEvents = ['touchstart', 'touchend', 'click'];
    const onFirstInteraction = () => {
        initAudio();
        // ÁßªÈô§ÁõëÂê¨Âô®
        userInteractionEvents.forEach(event => {
            document.removeEventListener(event, onFirstInteraction);
        });
    };

    userInteractionEvents.forEach(event => {
        document.addEventListener(event, onFirstInteraction, { once: true });
    });
}

function playSound(type) {
    if (!soundEnabled || !audioContext) return;
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    const currentTime = audioContext.currentTime;
    
    switch(type) {
        case 'block':
            oscillator.frequency.value = 800;
            oscillator.type = 'square';
            gainNode.gain.setValueAtTime(0.3, currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.1);
            oscillator.start(currentTime);
            oscillator.stop(currentTime + 0.1);
            break;
        case 'break':
            oscillator.frequency.value = 600;
            oscillator.type = 'sawtooth';
            gainNode.gain.setValueAtTime(0.2, currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.2);
            oscillator.start(currentTime);
            oscillator.stop(currentTime + 0.2);
            break;
        case 'experience':
            for (let i = 0; i < 3; i++) {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.value = 800 + (i * 200);
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.2, currentTime + i * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, currentTime + i * 0.1 + 0.2);
                osc.start(currentTime + i * 0.1);
                osc.stop(currentTime + i * 0.1 + 0.2);
            }
            break;
        case 'creeper':
            oscillator.frequency.value = 100;
            oscillator.type = 'sawtooth';
            gainNode.gain.setValueAtTime(0.1, currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, currentTime + 1.5);
            oscillator.start(currentTime);
            oscillator.stop(currentTime + 1.5);
            break;
        case 'portal':
            oscillator.frequency.value = 400;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.2, currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.5);
            oscillator.start(currentTime);
            oscillator.stop(currentTime + 0.5);
            break;
        case 'villager':
            oscillator.frequency.value = 500;
            oscillator.type = 'square';
            gainNode.gain.setValueAtTime(0.15, currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.15);
            oscillator.start(currentTime);
            oscillator.stop(currentTime + 0.15);
            break;
    }
}

function initSoundToggle() {
    const soundToggle = document.getElementById('soundToggle');
    soundToggle.addEventListener('click', () => {
        soundEnabled = !soundEnabled;
        soundToggle.classList.toggle('muted');

        if (soundEnabled) {
            showToast('üîä Èü≥ÊïàÂ∑≤ÂºÄÂêØ', 'info');
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        } else {
            showToast('üîá Èü≥ÊïàÂ∑≤ÂÖ≥Èó≠', 'warning');
        }

        buttonClickFeedback(soundToggle);
    });
}

function init3DFloatingBlocks() {
    const container = document.querySelector('.floating-blocks-3d');
    const colors = [
        'linear-gradient(135deg, rgba(124, 179, 66, 0.3) 0%, rgba(85, 139, 47, 0.3) 100%)',
        'linear-gradient(135deg, rgba(79, 195, 247, 0.3) 0%, rgba(2, 136, 209, 0.3) 100%)',
        'linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 165, 0, 0.3) 100%)',
        'linear-gradient(135deg, rgba(229, 115, 115, 0.3) 0%, rgba(211, 47, 47, 0.3) 100%)',
        'linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(56, 142, 60, 0.3) 100%)'
    ];
    
    const isMobile = window.innerWidth < 768;
    const blockCount = isMobile ? 8 : 15;
    
    for (let i = 0; i < blockCount; i++) {
        const block = document.createElement('div');
        block.className = 'floating-block-3d';
        
        const size = Math.random() * 30 + 30;
        const startPosition = Math.random() * 100;
        const delay = Math.random() * 20;
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        block.style.cssText = `
            width: ${size}px;
            height: ${size}px;
            background: ${color};
            left: ${startPosition}%;
            animation-delay: ${delay}s;
        `;
        
        container.appendChild(block);
    }
}

function initFireworks() {
    const canvas = document.getElementById('fireworksCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // Global particles array shared by all fireworks
    let allParticles = [];
    let animationFrameId = null;
    let isAnimating = false;
    let forceStopTimeout = null;
    
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
    
    // Single animation loop that manages all particles
    function animate() {
        // Clear canvas before each frame
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Filter out dead particles
        allParticles = allParticles.filter(p => p.life > 0);
        
        // Update and draw all alive particles
        allParticles.forEach(p => {
            // Update particle physics
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.1; // Gravity
            p.life -= p.decay; // Life decay
            
            // Draw particle with opacity based on life
            ctx.globalAlpha = Math.max(0, p.life);
            ctx.fillStyle = p.color;
            ctx.fillRect(Math.floor(p.x / 5) * 5, Math.floor(p.y / 5) * 5, 5, 5);
        });
        
        // Reset global alpha
        ctx.globalAlpha = 1;
        
        // Continue animation if particles exist
        if (allParticles.length > 0) {
            animationFrameId = requestAnimationFrame(animate);
        } else {
            // Stop animation when no particles left
            stopAnimation();
        }
    }
    
    // Start animation loop if not already running
    function startAnimation() {
        if (!isAnimating) {
            isAnimating = true;
            animate();
            
            // Force stop after 5 seconds to ensure cleanup (for both desktop and mobile)
            if (forceStopTimeout) {
                clearTimeout(forceStopTimeout);
            }
            forceStopTimeout = setTimeout(() => {
                forceStopAnimation();
            }, 5000);
        }
    }
    
    // Stop animation normally
    function stopAnimation() {
        isAnimating = false;
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        // Final cleanup - ensure canvas is completely clear
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (forceStopTimeout) {
            clearTimeout(forceStopTimeout);
            forceStopTimeout = null;
        }
    }
    
    // Force stop animation and clear everything
    function forceStopAnimation() {
        allParticles = [];
        stopAnimation();
    }
    
    window.launchFireworks = function() {
        const isMobile = window.innerWidth < 768;
        const fireworkCount = isMobile ? 2 : 3;
        
        // Limit total particles to prevent accumulation
        const maxParticles = isMobile ? 150 : 300;
        
        for (let i = 0; i < fireworkCount; i++) {
            setTimeout(() => {
                // Check particle limit before creating new firework
                if (allParticles.length < maxParticles) {
                    createFirework(canvas.width, canvas.height, allParticles, maxParticles);
                    startAnimation();
                }
            }, i * 300);
        }
    };
}

function createFirework(width, height, allParticles, maxParticles) {
    const x = Math.random() * width;
    const y = Math.random() * height * 0.5;
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#FFD700'];
    const isMobile = window.innerWidth < 768;
    const particleCount = isMobile ? 30 : 50;
    
    // Calculate how many particles we can actually add
    const availableSlots = maxParticles - allParticles.length;
    const actualParticleCount = Math.min(particleCount, availableSlots);
    
    for (let i = 0; i < actualParticleCount; i++) {
        const angle = (Math.PI * 2 * i) / actualParticleCount;
        const velocity = Math.random() * 3 + 2;
        
        allParticles.push({
            x: x,
            y: y,
            vx: Math.cos(angle) * velocity,
            vy: Math.sin(angle) * velocity,
            color: colors[Math.floor(Math.random() * colors.length)],
            life: 1.0,
            decay: 0.025 // Increased decay rate - particles will live for ~40 frames (~1.5-2 seconds at 60fps)
        });
    }
}

function initPortalEffect() {
    const canvas = document.getElementById('portalCanvas');
    const ctx = canvas.getContext('2d');
    const container = canvas.parentElement;
    
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight;
    
    const particles = [];
    for (let i = 0; i < 30; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            vx: (Math.random() - 0.5) * 0.5,
            vy: (Math.random() - 0.5) * 0.5,
            size: Math.random() * 3 + 1
        });
    }
    
    function animatePortal() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach(p => {
            ctx.fillStyle = `rgba(139, 0, 255, ${Math.random() * 0.5 + 0.3})`;
            ctx.fillRect(Math.floor(p.x / 3) * 3, Math.floor(p.y / 3) * 3, p.size, p.size);
            
            p.x += p.vx;
            p.y += p.vy;
            
            if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
            if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
        });
        
        requestAnimationFrame(animatePortal);
    }
    
    animatePortal();
}

function initPhotoPixelate() {
    try {
        const photo = document.getElementById('mainPhoto');
        const btn = document.getElementById('pixelateBtn');

        if (!photo || !btn) {
            console.error('ÁÖßÁâáÂÉèÁ¥†ÂåñÂäüËÉΩÔºöÁº∫Â∞ëÂøÖË¶ÅÂÖÉÁ¥†');
            return;
        }

        let isPixelated = false;

        btn.addEventListener('click', () => {
            try {
                isPixelated = !isPixelated;
                photo.classList.toggle('pixelated');
                btn.textContent = isPixelated ? 'ËøòÂéüÁÖßÁâá' : 'ÂÉèÁ¥†Âåñ';
                playSound('block');
                buttonClickFeedback(btn);

                if (isPixelated) {
                    showToast('üé® ÁÖßÁâáÂ∑≤ÂÉèÁ¥†ÂåñÔºÅ', 'success');
                    unlockAchievement('pixelate', 'üé® ÂÉèÁ¥†Â§ßÂ∏à', 'ÂèëÁé∞ÂÉèÁ¥†ÂåñÁÖßÁâáÊïàÊûúÔºÅ');
                } else {
                    showToast('üì∑ ÁÖßÁâáÂ∑≤ËøòÂéüÔºÅ', 'info');
                }
            } catch (error) {
                console.error('ÁÖßÁâáÂÉèÁ¥†ÂåñÂäüËÉΩÈîôËØØ:', error);
            }
        });

        const prevBtn = document.getElementById('photoPrev');
        const nextBtn = document.getElementById('photoNext');

        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                try {
                    playSound('portal');
                    buttonClickFeedback(prevBtn);
                    showToast('‚óÄ ÂàáÊç¢ÁÖßÁâá', 'info');
                    launchFireworks();
                    photosViewed.add('prev');
                    checkPhotoExplorer();
                } catch (error) {
                    console.error('ÁÖßÁâáÂâç‰∏ÄÂº†ÂäüËÉΩÈîôËØØ:', error);
                }
            });
        }

        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                try {
                    playSound('portal');
                    buttonClickFeedback(nextBtn);
                    showToast('ÂàáÊç¢ÁÖßÁâá ‚ñ∂', 'info');
                    launchFireworks();
                    photosViewed.add('next');
                    checkPhotoExplorer();
                } catch (error) {
                    console.error('ÁÖßÁâá‰∏ã‰∏ÄÂº†ÂäüËÉΩÈîôËØØ:', error);
                }
            });
        }
    } catch (error) {
        console.error('ÂàùÂßãÂåñÁÖßÁâáÂÉèÁ¥†ÂåñÂäüËÉΩÈîôËØØ:', error);
    }
}

function checkPhotoExplorer() {
    if (photosViewed.size >= 3) {
        unlockAchievement('explorer', 'üó∫Ô∏è Êé¢Èô©ÂÆ∂', 'ÊµèËßà‰∫ÜÊâÄÊúâÁÖßÁâáÔºÅ');
    }
}

function initPhotoGestures() {
    const photoWrapper = document.getElementById('photoWrapper');
    let touchStartX = 0;
    let touchStartY = 0;
    let touchStartTime = 0;
    let lastTapTime = 0;
    
    photoWrapper.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        touchStartTime = Date.now();
    }, { passive: true });
    
    photoWrapper.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const touchEndTime = Date.now();
        
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;
        const timeDiff = touchEndTime - touchStartTime;
        
        if (timeDiff < 300 && Math.abs(diffX) < 10 && Math.abs(diffY) < 10) {
            const currentTime = Date.now();
            if (currentTime - lastTapTime < 300) {
                openPhotoModal();
            }
            lastTapTime = currentTime;
        }
        
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            if (diffX > 0) {
                document.getElementById('photoNext').click();
            } else {
                document.getElementById('photoPrev').click();
            }
        }
    }, { passive: true });
}

function initPhotoModal() {
    const modal = document.getElementById('photoModal');
    const modalPhoto = document.getElementById('modalPhoto');
    const modalClose = document.getElementById('modalClose');
    const mainPhoto = document.getElementById('mainPhoto');
    
    modalClose.addEventListener('click', closePhotoModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closePhotoModal();
        }
    });
}

function openPhotoModal() {
    const modal = document.getElementById('photoModal');
    const modalPhoto = document.getElementById('modalPhoto');
    const mainPhoto = document.getElementById('mainPhoto');
    
    modalPhoto.src = mainPhoto.src;
    modal.classList.add('show');
    playSound('portal');
}

function closePhotoModal() {
    const modal = document.getElementById('photoModal');
    modal.classList.remove('show');
}

function initHiddenCreeper() {
    try {
        const creeper = document.getElementById('hiddenCreeper');
        
        if (!creeper) {
            console.error('Ëã¶ÂäõÊÄïÂΩ©ËõãÂäüËÉΩÔºöÁº∫Â∞ëÂøÖË¶ÅÂÖÉÁ¥†');
            return;
        }
        
        const positions = [
            { top: '80px', left: '20px' },
            { top: '80px', right: '100px' },
            { bottom: '150px', left: '30px' },
            { bottom: '150px', right: '30px' },
            { top: '300px', left: '15px' },
            { top: '300px', right: '15px' }
        ];
        
        const randomPos = positions[Math.floor(Math.random() * positions.length)];
        Object.keys(randomPos).forEach(key => {
            creeper.style[key] = randomPos[key];
        });
        
        creeper.addEventListener('click', () => {
            try {
                playSound('creeper');
                createMegaExplosion(creeper);
                showToast('üíö ÂèëÁé∞ÈöêËóèÁöÑËã¶ÂäõÊÄïÔºÅ', 'success');
                unlockAchievement('hidden_creeper', 'üíö ÂèëÁé∞‰∫ÜÂÆ≥ÁæûÁöÑËã¶ÂäõÊÄïÔºÅ', '‰Ω†ÊâæÂà∞‰∫ÜÈöêËóèÁöÑÂΩ©ËõãÔºÅ');

                creeper.style.animation = 'creeperCelebrate 0.5s ease-out';
                setTimeout(() => {
                    creeper.style.animation = '';
                }, 500);

                launchFireworks();
                launchFireworks();
            } catch (error) {
                console.error('Ëã¶ÂäõÊÄïÂΩ©ËõãÂäüËÉΩÈîôËØØ:', error);
            }
        });
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes creeperCelebrate {
                0%, 100% { transform: rotate(0deg) scale(1); }
                25% { transform: rotate(-15deg) scale(1.2); }
                75% { transform: rotate(15deg) scale(1.2); }
            }
        `;
        document.head.appendChild(style);
    } catch (error) {
        console.error('ÂàùÂßãÂåñËã¶ÂäõÊÄïÂΩ©ËõãÂäüËÉΩÈîôËØØ:', error);
    }
}

function createMegaExplosion(element) {
    const rect = element.getBoundingClientRect();
    const emojis = ['üíö', 'üí•', '‚ú®', '‚≠ê', 'üéâ', 'üéä', 'üíé', 'üéÅ', 'üåü', '‚ö°', 'üí´'];
    
    for (let i = 0; i < 20; i++) {
        const emoji = emojis[Math.floor(Math.random() * emojis.length)];
        const explosion = document.createElement('div');
        explosion.textContent = emoji;
        
        const angle = (Math.PI * 2 * i) / 20;
        const distance = 150 + Math.random() * 100;
        const tx = Math.cos(angle) * distance;
        const ty = Math.sin(angle) * distance;
        
        explosion.style.cssText = `
            position: fixed;
            left: ${rect.left + rect.width / 2}px;
            top: ${rect.top + rect.height / 2}px;
            font-size: ${2 + Math.random() * 2}em;
            pointer-events: none;
            z-index: 9999;
            animation: megaExplosionAnim 1.5s ease-out forwards;
        `;
        
        explosion.style.setProperty('--tx', `${tx}px`);
        explosion.style.setProperty('--ty', `${ty}px`);
        
        document.body.appendChild(explosion);
        setTimeout(() => explosion.remove(), 1500);
    }
    
    if (!document.getElementById('mega-explosion-style')) {
        const style = document.createElement('style');
        style.id = 'mega-explosion-style';
        style.textContent = `
            @keyframes megaExplosionAnim {
                0% {
                    opacity: 1;
                    transform: translate(0, 0) scale(0) rotate(0deg);
                }
                50% {
                    opacity: 1;
                }
                100% {
                    opacity: 0;
                    transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(360deg);
                }
            }
        `;
        document.head.appendChild(style);
    }
}

function initPixelCake() {
    try {
        const blowBtn = document.getElementById('blowCandleBtn');
        const candle = document.getElementById('cakeCandle');
        const flame = candle.querySelector('.candle-flame');
        const hint = document.querySelector('.candle-hint');

        if (!blowBtn || !candle || !flame || !hint) {
            console.error('ÂêπËú°ÁÉõÂäüËÉΩÔºöÁº∫Â∞ëÂøÖË¶ÅÂÖÉÁ¥†');
            return;
        }

        let isBlown = false;

        blowBtn.addEventListener('click', () => {
            try {
                buttonClickFeedback(blowBtn);

                if (isBlown) {
                    flame.classList.remove('blown');
                    isBlown = false;
                    blowBtn.textContent = 'ÂêπËú°ÁÉõ üéÇ';
                    hint.classList.remove('hidden');
                    showToast('üî• Ëú°ÁÉõÂ∑≤ÁÇπÁáÉ', 'info');
                } else {
                    flame.classList.add('blown');
                    isBlown = true;
                    blowBtn.textContent = 'ÁÇπÁáÉËú°ÁÉõ üî•';
                    hint.classList.add('hidden');
                    showToast('üéÇ Ëú°ÁÉõÂ∑≤ÂêπÁÅ≠ÔºÅËÆ∏‰∏™ÊÑøÂêßÔºÅ', 'success');

                    playSound('experience');

                    setTimeout(() => {
                        launchFireworks();
                        launchFireworks();
                        createConfetti();
                        unlockAchievement('cake_blown', 'üéÇ ËÆ∏ÊÑøÊàêÂäü', 'ÂêπÁÅ≠‰∫ÜÁîüÊó•Ëú°ÁÉõÔºÅ');
                    }, 300);
                }
            } catch (error) {
                console.error('ÂêπËú°ÁÉõÂäüËÉΩÈîôËØØ:', error);
            }
        });
    } catch (error) {
        console.error('ÂàùÂßãÂåñÂêπËú°ÁÉõÂäüËÉΩÈîôËØØ:', error);
    }
}

function createConfetti() {
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#FFD700', '#FF69B4', '#7CB342'];
    
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
            position: fixed;
            left: ${Math.random() * 100}vw;
            top: -20px;
            width: 10px;
            height: 10px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            animation: confettiFall ${2 + Math.random() * 2}s linear forwards;
            z-index: 9999;
            transform: rotate(${Math.random() * 360}deg);
        `;
        
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 4000);
    }
    
    if (!document.getElementById('confetti-style')) {
        const style = document.createElement('style');
        style.id = 'confetti-style';
        style.textContent = `
            @keyframes confettiFall {
                0% {
                    transform: translateY(0) rotate(0deg);
                    opacity: 1;
                }
                100% {
                    transform: translateY(100vh) rotate(720deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    }
}

function initBlessingGenerator() {
    const blessings = [
        'ÊÑø‰Ω†ÁöÑÁîüÂëΩÂÄºÊ∞∏ËøúÊª°Ê†ºÔºÅ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è',
        'Á•ù‰Ω†Ëé∑ÂæóÁ®ÄÊúâÈôÑÈ≠îÔºöÂø´‰πêVÁ∫ßÔºÅ‚ú®',
        'Happy BirthdayÔºÅÁªèÈ™å+5Â≤ÅÔºÅ‚≠ê',
        'ÊÑø‰Ω†ÁöÑÂÜíÈô©‰πãË∑ØÂÖÖÊª°ÈíªÁü≥ÔºÅüíé',
        'Á•ù‰Ω†ÊØèÂ§©ÈÉΩËÉΩÊâæÂà∞ÈöêËóèÂÆùÁÆ±ÔºÅüéÅ',
        'ÊÑø‰Ω†Êã•ÊúâÊó†ÈôêÁöÑÂàõÈÄ†ÂäõÔºÅüåà',
        'ÊÅ≠ÂñúÂçáÁ∫ßÂà∞5Á∫ßÁé©ÂÆ∂ÔºÅüèÜ',
        'Ëé∑ÂæóÊàêÂ∞±ÔºöÊúÄÂø´‰πêÁöÑ5Â≤ÅÔºÅüéâ',
        'Á•ùÁ¶èÊïàÊûúÔºöÂπ∏ËøêBUFFÊ∞∏‰πÖÁîüÊïàÔºÅüçÄ',
        'ÊÑø‰Ω†Âª∫ÈÄ†ÊúÄÁæéÁöÑÊ¢¶ÊÉ≥‰∏ñÁïåÔºÅüè∞',
        '‰º†ËØ¥Ë£ÖÂ§áËé∑ÂæóÔºöÂø´‰πê‰πãÂâëÔºÅ‚öîÔ∏è',
        'ÊÑø‰Ω†ÁöÑËÉåÂåÖË£ÖÊª°Ê¨¢Á¨ëÂíåÁà±ÔºÅüéí',
    ];
    
    const textElement = document.getElementById('blessingText');
    const btn = document.getElementById('generateBlessing');
    let lastIndex = 0;
    
    btn.addEventListener('click', () => {
        let newIndex;
        do {
            newIndex = Math.floor(Math.random() * blessings.length);
        } while (newIndex === lastIndex && blessings.length > 1);

        lastIndex = newIndex;

        textElement.style.transform = 'scale(0)';
        textElement.style.opacity = '0';

        setTimeout(() => {
            textElement.textContent = blessings[newIndex];
            textElement.style.transform = 'scale(1)';
            textElement.style.opacity = '1';
        }, 200);

        playSound('experience');
        createSparkles(btn);
        buttonClickFeedback(btn);
        showToast('‚ú® Ëé∑ÂæóÊñ∞Á•ùÁ¶èÔºÅ', 'success');

        unlockAchievement('blessing', 'üìú Á•ùÁ¶èÊî∂ÈõÜËÄÖ', 'Ëé∑Âèñ‰∫ÜÁ•ûÁßòÁ•ùÁ¶èÔºÅ');
    });
}

function initMiningGame() {
    try {
        const miningArea = document.getElementById('miningArea');
        const scoreDisplay = document.getElementById('miningScore');
        const startBtn = document.getElementById('startMining');
        
        if (!miningArea || !scoreDisplay || !startBtn) {
            console.error('ÊåñÊñπÂùóÊ∏∏ÊàèÂäüËÉΩÔºöÁº∫Â∞ëÂøÖË¶ÅÂÖÉÁ¥†');
            return;
        }
        
        let score = 0;
        let gameActive = false;
        let blockInterval;
    
    const blockTypes = [
        { emoji: 'üü´', color: '#8D6E63', points: 1, blessing: 'ÊåñÂà∞‰∫ÜÊ≥•ÂúüÔºÅ' },
        { emoji: '‚ö´', color: '#757575', points: 2, blessing: 'Ëé∑ÂæóÁü≥Â§¥ÔºÅ' },
        { emoji: 'üíé', color: '#4FC3F7', points: 10, blessing: 'ÈíªÁü≥ÔºÅÔºÅÔºÅ' },
        { emoji: 'üü°', color: '#FFD700', points: 5, blessing: 'ÈáëÁüøÔºÅ' },
        { emoji: 'üü¢', color: '#4CAF50', points: 8, blessing: 'ÁªøÂÆùÁü≥ÔºÅ' },
        { emoji: 'üî¥', color: '#F44336', points: 3, blessing: 'Á∫¢Áü≥ÔºÅ' }
    ];
    
    startBtn.addEventListener('click', () => {
        if (gameActive) {
            stopGame();
        } else {
            startGame();
        }
    });

    function startGame() {
        gameActive = true;
        score = 0;
        scoreDisplay.textContent = score;
        startBtn.textContent = 'ÂÅúÊ≠¢Ê∏∏Êàè';
        miningArea.innerHTML = '';
        buttonClickFeedback(startBtn);
        showToast('‚õèÔ∏è ÊåñÁüøÊ∏∏ÊàèÂºÄÂßãÔºÅ30ÁßíÂÄíËÆ°Êó∂ÔºÅ', 'success');

        spawnBlock();
        blockInterval = setInterval(spawnBlock, 1500);

        // Ê∑ªÂä†ÂÄíËÆ°Êó∂ÊèêÈÜí
        let timeLeft = 30;
        const countdownInterval = setInterval(() => {
            timeLeft--;
            if (timeLeft === 20) {
                showToast('‚è∞ ËøòÂâ©20ÁßíÔºÅ', 'info');
            } else if (timeLeft === 10) {
                showToast('‚è∞ ËøòÂâ©10ÁßíÔºÅÂø´ÁÇπÊåñÔºÅ', 'warning');
            } else if (timeLeft === 5) {
                showToast('‚è∞ ÊúÄÂêé5ÁßíÔºÅÔºÅÔºÅ', 'warning');
            }
        }, 1000);

        setTimeout(() => {
            clearInterval(countdownInterval);
            if (gameActive) {
                stopGame();
                if (score >= 50) {
                    showToast('üèÜ ÊåñÁüøÂ§ßÂ∏àÔºÅÂæóÂàÜÔºö' + score, 'success');
                    unlockAchievement('mining_master', '‚õèÔ∏è ÊåñÁüøÂ§ßÂ∏à', 'ÊåñÁüøÊ∏∏ÊàèÂæóÂàÜË∂ÖËøá50ÔºÅ');
                } else {
                    showToast('‚õèÔ∏è Ê∏∏ÊàèÁªìÊùüÔºÅÂæóÂàÜÔºö' + score, 'info');
                }
            }
        }, 30000);
    }

    function stopGame() {
        gameActive = false;
        startBtn.textContent = 'ÂºÄÂßãÊ∏∏Êàè';
        clearInterval(blockInterval);
        buttonClickFeedback(startBtn);
    }
    
    function spawnBlock() {
        if (!gameActive) return;
        
        const blockType = blockTypes[Math.floor(Math.random() * blockTypes.length)];
        const block = document.createElement('div');
        block.className = 'mining-block';
        block.textContent = blockType.emoji;
        block.style.backgroundColor = blockType.color;
        
        const maxX = miningArea.offsetWidth - 70;
        const maxY = miningArea.offsetHeight - 70;
        block.style.left = Math.random() * maxX + 'px';
        block.style.top = Math.random() * maxY + 'px';
        
        block.addEventListener('click', () => {
            if (!gameActive) return;
            
            score += blockType.points;
            scoreDisplay.textContent = score;
            
            miningBlocksDestroyed++;
            if (miningBlocksDestroyed >= 10) {
                unlockAchievement('mining_expert', '‚õèÔ∏è ÊåñÁüøËææ‰∫∫', 'ÊåñÊéò‰∫Ü10‰∏™ÊñπÂùóÔºÅ');
            }
            
            block.classList.add('breaking');
            playSound('break');
            
            const blessing = document.createElement('div');
            blessing.className = 'blessing-drop';
            blessing.textContent = blockType.blessing;
            blessing.style.left = block.style.left;
            blessing.style.top = block.style.top;
            miningArea.appendChild(blessing);
            
            setTimeout(() => blessing.remove(), 2000);
            setTimeout(() => block.remove(), 300);
        });
        
        miningArea.appendChild(block);
        
        setTimeout(() => {
            if (block.parentElement && gameActive) {
                block.remove();
            }
        }, 3000);
    }
    } catch (error) {
        console.error('ÂàùÂßãÂåñÊåñÊñπÂùóÊ∏∏ÊàèÂäüËÉΩÈîôËØØ:', error);
    }
}

function initCakeBuilding() {
    try {
        const cakeDisplay = document.getElementById('cakeDisplay');
        const cakeBlocks = document.querySelectorAll('.cake-block-btn');
        const resetBtn = document.getElementById('resetCake');
        
        if (!cakeDisplay || !cakeBlocks || cakeBlocks.length === 0 || !resetBtn) {
            console.error('ËõãÁ≥ïÂª∫ÈÄ†Ê∏∏ÊàèÂäüËÉΩÔºöÁº∫Â∞ëÂøÖË¶ÅÂÖÉÁ¥†');
            return;
        }
        
        let layers = [];
        
        cakeBlocks.forEach(btn => {
            btn.addEventListener('click', () => {
                try {
                    const layerType = btn.dataset.layer;
                    const emoji = btn.textContent;
                    
                    if (layerType === 'candle' && layers.length === 0) {
                        return;
                    }
                    
                    const layer = document.createElement('div');
                    layer.className = 'cake-layer';
                    layer.textContent = emoji;
                    
                    if (layerType === '1') {
                        layer.style.background = 'linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%)';
                    } else if (layerType === '2') {
                        layer.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                    } else if (layerType === '3') {
                        layer.style.background = 'linear-gradient(135deg, #FF6B6B 0%, #FF4444 100%)';
                    }
                    
                    cakeDisplay.appendChild(layer);
                    layers.push(emoji);
                    
                    playSound('block');
                    
                    if (layers.includes('üïØÔ∏è') && layers.length >= 4) {
                        setTimeout(() => {
                            launchFireworks();
                            unlockAchievement('cake', 'üéÇ ËõãÁ≥ïÂª∫ÈÄ†Â∏à', 'ÊàêÂäüÂª∫ÈÄ†‰∫ÜÁîüÊó•ËõãÁ≥ïÔºÅ');
                            playSound('experience');
                        }, 300);
                    }
                } catch (error) {
                    console.error('ËõãÁ≥ïÂª∫ÈÄ†ÂäüËÉΩÈîôËØØ:', error);
                }
            });
        });
        
        resetBtn.addEventListener('click', () => {
            try {
                cakeDisplay.innerHTML = '';
                layers = [];
                playSound('block');
            } catch (error) {
                console.error('ÈáçÁΩÆËõãÁ≥ïÂäüËÉΩÈîôËØØ:', error);
            }
        });
    } catch (error) {
        console.error('ÂàùÂßãÂåñËõãÁ≥ïÂª∫ÈÄ†Ê∏∏ÊàèÂäüËÉΩÈîôËØØ:', error);
    }
}

function initVillagerNPC() {
    try {
        const villager = document.getElementById('villagerNpc');
        const bubble = document.getElementById('villagerBubble');
        
        if (!villager || !bubble) {
            console.error('ÊùëÊ∞ëNPCÂäüËÉΩÔºöÁº∫Â∞ëÂøÖË¶ÅÂÖÉÁ¥†');
            return;
        }
        
        const messages = [
            'ÂìºÂìºÔºÅÁîüÊó•Âø´‰πêÔºÅüéâ',
            'ÊàëÊúâÂ•Ω‰∏úË•øË¶ÅÂçñÁªô‰Ω†...ÂºÄÁé©Á¨ëÁöÑÔºÅüòÑ',
            '5Â≤ÅÂï¶ÔºÅÁúüÊòØ‰∏™Â•ΩÂπ¥Á∫™ÔºÅ',
            'Á•ù‰Ω†ÂÅ•Â∫∑ÊàêÈïøÔºÅüíö',
            'Ë¶Å‰∏çË¶ÅÂíåÊàëÂÅö‰∫§ÊòìÔºüü§ù',
            'Âê¨ËØ¥‰ªäÂ§©Êúâ‰∏™Â∞èÊúãÂèãËøáÁîüÊó•ÔºüüéÇ',
            'ÂìºÂìºÂìº~~~',
            '‰Ω†ÁúãËµ∑Êù•ÂæàÂºÄÂøÉÔºÅüòä'
        ];
        
        let bubbleTimeout;
        
        villager.addEventListener('click', () => {
            try {
                const message = messages[Math.floor(Math.random() * messages.length)];
                bubble.textContent = message;
                bubble.classList.add('show');

                playSound('villager');
                showToast('üßë‚Äçüåæ ' + message, 'info');

                clearTimeout(bubbleTimeout);
                bubbleTimeout = setTimeout(() => {
                    bubble.classList.remove('show');
                }, 3000);

                unlockAchievement('villager', 'üßë‚Äçüåæ ÊùëÊ∞ëÊúãÂèã', 'ÂíåÊùëÊ∞ëNPC‰∫íÂä®‰∫ÜÔºÅ');
            } catch (error) {
                console.error('ÊùëÊ∞ëNPCÁÇπÂáªÂäüËÉΩÈîôËØØ:', error);
            }
        });
        
        setInterval(() => {
            try {
                if (!bubble.classList.contains('show')) {
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    bubble.textContent = randomMessage;
                    bubble.classList.add('show');
                    
                    setTimeout(() => {
                        bubble.classList.remove('show');
                    }, 2000);
                }
            } catch (error) {
                console.error('ÊùëÊ∞ëNPCËá™Âä®Ê∂àÊÅØÈîôËØØ:', error);
            }
        }, 20000);
    } catch (error) {
        console.error('ÂàùÂßãÂåñÊùëÊ∞ëNPCÂäüËÉΩÈîôËØØ:', error);
    }
}

function initBlockInteraction() {
    try {
        const blocks = document.querySelectorAll('.minecraft-cube');
        const messageDisplay = document.getElementById('messageDisplay');
        
        if (!blocks || blocks.length === 0 || !messageDisplay) {
            console.error('ÊñπÂùó‰∫íÂä®ÂäüËÉΩÔºöÁº∫Â∞ëÂøÖË¶ÅÂÖÉÁ¥†');
            return;
        }
        
        blocks.forEach(block => {
            block.addEventListener('click', function() {
                try {
                    const message = this.dataset.message;
                    
                    messageDisplay.textContent = message;
                    messageDisplay.classList.add('show');
                    
                    createParticles(this);
                    playSound('block');
                    
                    setTimeout(() => {
                        messageDisplay.classList.remove('show');
                    }, 3000);
                } catch (error) {
                    console.error('ÊñπÂùóÁÇπÂáªÂäüËÉΩÈîôËØØ:', error);
                }
            });
        });
    } catch (error) {
        console.error('ÂàùÂßãÂåñÊñπÂùó‰∫íÂä®ÂäüËÉΩÈîôËØØ:', error);
    }
}

function createParticles(element) {
    const rect = element.getBoundingClientRect();
    const particles = ['‚ú®', '‚≠ê', 'üí´', 'üåü', 'üí•', '‚ö°'];
    
    for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.textContent = particles[Math.floor(Math.random() * particles.length)];
        particle.style.cssText = `
            position: fixed;
            left: ${rect.left + rect.width / 2}px;
            top: ${rect.top + rect.height / 2}px;
            font-size: 1.5em;
            pointer-events: none;
            z-index: 9999;
            animation: particleExplosion 1s ease-out forwards;
        `;
        
        const angle = (Math.PI * 2 * i) / 8;
        const distance = 100;
        particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
        particle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
        
        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 1000);
    }
    
    if (!document.getElementById('particle-style')) {
        const style = document.createElement('style');
        style.id = 'particle-style';
        style.textContent = `
            @keyframes particleExplosion {
                0% {
                    opacity: 1;
                    transform: translate(0, 0) scale(1);
                }
                100% {
                    opacity: 0;
                    transform: translate(var(--tx), var(--ty)) scale(0);
                }
            }
        `;
        document.head.appendChild(style);
    }
}

function createSparkles(element) {
    const rect = element.getBoundingClientRect();
    
    for (let i = 0; i < 5; i++) {
        const sparkle = document.createElement('div');
        sparkle.textContent = '‚ú®';
        sparkle.style.cssText = `
            position: fixed;
            left: ${rect.left + Math.random() * rect.width}px;
            top: ${rect.top + Math.random() * rect.height}px;
            font-size: ${Math.random() * 20 + 10}px;
            pointer-events: none;
            z-index: 9999;
            animation: sparkleAnim 1s ease-out forwards;
        `;
        
        document.body.appendChild(sparkle);
        setTimeout(() => sparkle.remove(), 1000);
    }
    
    if (!document.getElementById('sparkle-style')) {
        const style = document.createElement('style');
        style.id = 'sparkle-style';
        style.textContent = `
            @keyframes sparkleAnim {
                0% {
                    opacity: 1;
                    transform: scale(0) rotate(0deg);
                }
                50% {
                    opacity: 1;
                    transform: scale(1) rotate(180deg);
                }
                100% {
                    opacity: 0;
                    transform: scale(0) rotate(360deg);
                }
            }
        `;
        document.head.appendChild(style);
    }
}

function unlockAchievement(id, title, description) {
    if (achievements.has(id)) return;
    
    achievements.add(id);
    localStorage.setItem('chenle_achievements', JSON.stringify([...achievements]));
    
    const container = document.getElementById('achievementContainer');
    const achievement = document.createElement('div');
    achievement.className = 'achievement';
    achievement.innerHTML = `
        <div class="achievement-icon">üèÜ</div>
        <div class="achievement-content">
            <div class="achievement-title">${title}</div>
            <div class="achievement-desc">${description}</div>
        </div>
    `;
    
    container.appendChild(achievement);
    playSound('experience');
    
    setTimeout(() => {
        achievement.remove();
    }, 5000);
}

let touchStartX = 0;
let touchStartY = 0;

document.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
}, { passive: true });

document.addEventListener('touchend', (e) => {
    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;
    
    const diffX = touchStartX - touchEndX;
    const diffY = touchStartY - touchEndY;
    
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
        if (diffX > 0) {
            console.log('ÂêëÂ∑¶ÊªëÂä®');
        } else {
            console.log('ÂêëÂè≥ÊªëÂä®');
        }
    }
}, { passive: true });

window.addEventListener('orientationchange', () => {
    setTimeout(() => {
        const canvas = document.getElementById('fireworksCanvas');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const portalCanvas = document.getElementById('portalCanvas');
        const container = portalCanvas.parentElement;
        portalCanvas.width = container.offsetWidth;
        portalCanvas.height = container.offsetHeight;
    }, 200);
});

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        console.log('üéÆ ÂàòÂÆ∏‰πêÁîüÊó•ÁΩëÁ´ôÂ∑≤Âä†ËΩΩÂÆåÊàêÔºÅ');
    });
}
